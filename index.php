<?php	session_start();	if ( !isset($_SESSION['user_id']) ) {		require_once ('includes/login_functions.inc.php');				$url = absolute_url('login.php');				header("location: $url");		exit();	}	$user = $_SESSION['user_id'];	$name = $_SESSION['first_name'];	$page_title = 'Calculate my spends';	$link = 'logout.php';	$linkText = 'Log out';		include ('includes/header.html');	        	echo '<h1>Hello ' .  $name . '</h1>';        				/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				// load in include file according to local/live environment				if ( !@include('includes/mysqli_connect.php') ) {					require_once ('mysqli_connect.php');				} else {                	require_once ('includes/mysqli_connect.php');				}								// Check when the user gets paid				$queryPay = "SELECT payday, wage FROM users WHERE user_id = " . $_SESSION['user_id'] . "";				$rp = mysqli_query($dbc, $queryPay);				$rowPay = mysqli_fetch_array($rp, MYSQLI_ASSOC);								/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				// Check the dates function. Takes the day and runs it through checkdate				// If checkdate fails initiate a backwards loop until we get a valid day				function validateDay($day) {					$month = date("m", strtotime("last month") );					$year = date("Y", strtotime("last month") );					if ( checkdate($month, $day, $year) ) {						// Date passes check, return as string						return $day;											} elseif ( !checkdate($month, $day, $year) ) {						// Date is invlaid, reduce by one until it passes validation						while ( !checkdate($month, $day, $year) ) {							$day--;						} //END WHILE						return $day;					} // END ELSEIF				} //END VALIDATEDAY								/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				//Check if the last date of pay was in this month or last month				//Do this by determining if current day is less than date of pay, equal to (got paid today) or greater then (got paid this month)				function lastPay($day) {					$currentDay = date('d');						// Check if paypday is on the weekend					// If so set to Friday					$date = date('Y-m-' . $day);					$date = strtotime($date);					$date = date('D', $date);					if ($date ==='Sat') {						$day -= 1;					} if ($date ==='Sun') {						$day -= 2;					}					//echo $day;					if ( $currentDay < $day ) {						// Got paid last month						$fromDateMonth = date('Y-m-' . $day, strtotime("last month") );						return $fromDateMonth;											} elseif ( $currentDay == $day ) {						// Got paid today						$fromDateMonth = date('Y-m-d');						return $fromDateMonth;											} elseif ( $currentDay > $day ) {						// Got paid this month						$fromDateMonth = date('Y-m-' . $day);						return $fromDateMonth;											}				} //END LASTPAY								/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				if ($rp) {					$wage = $rowPay['wage'];					// Check payday result and format the query to see how much spent since last pay					if ( $rowPay['payday'] == 'last' ) { // User gets paid on the last day of every month						$day = date('d',  strtotime('last day of last month') );						//Check when they last got paid						$fromDateMonth = lastPay($day);											} if ( is_numeric($rowPay['payday']) ) { // User gets paid on the XX of the month						// Check this payday is valid, ie. in range of previous month						$day = $rowPay['payday'];						$day = validateDay($day);						$fromDateMonth = lastPay($day);					}				} else {					//////////////////////////////////////////////////					// HAVE NOT SUPPLIED PAYDAY INFORMATION				}				if ( $fromDateMonth == date('Y-m-d') ) {					echo '<small>You got paid today!</small>';				} else {					echo '<small>You last got paid on: ' . $fromDateMonth . '</small>';				}                $query = "SELECT time, SUM(amount) AS 'sum' FROM monthly_spends_" . $user . " WHERE time > '$fromDateMonth';";				$query2 = "SELECT SUM(amount) AS 'sum2' FROM monthly_spends_" . $user . "";				                $r = mysqli_query($dbc, $query);                $row = mysqli_fetch_array($r, MYSQLI_ASSOC);								$r2 = mysqli_query($dbc, $query2);				$row2 = mysqli_fetch_array($r2, MYSQLI_ASSOC);			echo '<div class="section">';				// Output current spending since last pay day                if ($r) {										$totalSpend = $row['sum'];										function wage_spent($wage, $totalSpend) {						//echo $wage;						$percent = (int) ( ($totalSpend / $wage) * 100);						// $percent = 45; // for testing colour value						return $percent;					}										echo '<div class="divider">';					echo '<small>Current spend: </small><h2>£';					if ( $totalSpend <= 0 ) {						echo '0.00</h2>'; 						echo '</div>';					} else {						echo $totalSpend . '</h2>';						echo '</div>';						echo '<div class="divider">';						echo '<small>As a percentage: </small><h2 class="wage-percent">' . wage_spent($wage, $totalSpend) . '%</h2>';						echo '</div>';					}                } else {					echo '<div class="divider">';                    echo '<h2>AN ERROR OCCURRED</h2>';					echo '</div>';                }    							echo '<div class="divider">';				// Output total spend of all time				if ($r2) {										echo '<small>Total spend: </small><h2>£';					if ( $row2['sum2'] <= 0 ){						echo '0.00</h2>';					} else {						echo $row2['sum2'] . '</h2>';					}									} else {					echo '<h3>An error occurred.</h3>';						echo '<p class="error">Could not calculate total spending.</p>';				}					echo '</div>';			echo '</div>';			            ?>       	                <!-- Action buttons        	First simply scrolls to form and focusses first field            Second goes to the query page        -->                <div id="actions">            <!--<a href="#update" id="update">Update spending</a>-->            <a href="query.php" id="view-link">View all spending</a>        </div>                        <form class="form-horizontal" id="spends" name="spends" method="post" action="form-handler.php">                    <fieldset>               	<div class="legend-header">                	<legend class="update">Enter item</legend>                	</div>                 <div class="control-group">                      <label for="spend-title" class="control-label" >Title</label>                    <div class="controls">                    	<input name="spend-title" placeholder="Spend name" type="text" required />                    </div>				</div>                <div class="control-group">	                <label for="spend-amount" class="control-label" >Amount</label>                    <div class="controls">                     	<input name="spend-amount" placeholder="0.00" type="number" required max="9999" min="0" step="0.01" />                    </div>                </div>                <div class="control-group">                    <label for="spend-category" class="control-label" >Category </label>                    <div class="controls">                        <select name="spend-category" required="required" >                        	<option value="" selected="selected" disabled>Choose a category...</option>                            <?php                                date_default_timezone_set('GMT');								// Get the Spending categories class								require_once 'includes/Spend_Categories.php';								//Create a new Spend_Categories OBJECT								//Can pass a value to sort, 'Asc', 'Desc' or none								$spends = new Spend_Categories('Asc');															                                function make_category_pulldown($spends) {									//Access the internal getSpends function which returns an array									$categorys = $spends->getSpends();                                    foreach ($categorys as $key => $value) {                                        echo "<option value = '$value'>$value</option>";	                                    }                                }                                								//Pass the spends array to the function HERE!                                make_category_pulldown($spends);                                                        ?>                        </select>					</div>				</div>                <div class="control-group">                	<label for="spend-description" class="control-label" >Description</label>                    <div class="controls">	                    <textarea name="spend-description" placeholder="Description (optional)" rows="3" cols="40"></textarea>                    </div>                </div>                                </fieldset>            <div class="control-group">                <div class="controls">		            <button type="submit" class="btn btn-primary">Update spends</button>                </div>            </div>            <input type="hidden" name="submitted" value="TRUE" />            <input type="hidden" name="start" value="<?php echo time(); ?>" />        </form>                <?php			include ('includes/footer.html');		?>