<?php	session_start();	if ( !isset($_SESSION['user_id']) ) {		require_once ('includes/login_functions.inc.php');				$url = absolute_url('login.php');				header("location: $url");		exit();	}	$user = $_SESSION['user_id'];	$name = $_SESSION['first_name'];	$page_title = 'View my spending';	$link = 'logout.php';	$linkText = 'Log out';		include ('includes/header.html');?>        <form class="form-horizontal" id="spends" name="spends" method="post" action="query.php">                    <fieldset>                <legend class="query">Query spending</legend>                     <div class="control-group">                    <label for="spend-category" class="control-label" >Category </label>                    <div class="controls">                        <select name="spend-category" required="required" >                        	<option value="" selected="selected" disabled>Choose a category...</option>                            <?php								// Get the Spending categories class								require_once 'includes/Spend_Categories.php';								//Create a new Spend_Categories OBJECT								//Can pass a value to sort, 'Asc', 'Desc' or none								$spends = new Spend_Categories('Asc');															                                function make_category_pulldown($spends) {									//Access the internal getSpends function which returns an array									$categorys = $spends->getSpends();                                    foreach ($categorys as $key => $value) {                                        echo "<option value = '$value'>$value</option>";	                                    }                                }                                								//Pass the spends array to the function HERE!                                make_category_pulldown($spends);                                                        ?>                        </select>					</div>				</div>                                  </fieldset>            <div class="control-group">                <div class="controls">		            <button type="submit" class="btn btn-primary">View spending</button>                </div>            </div>            <input type="hidden" name="submitted" value="TRUE" />        </form>                     <?php				/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				// load in include file according to local/live environment				if ( !@include('includes/mysqli_connect.php') ) {					require_once ('mysqli_connect.php');				} else {                	require_once ('includes/mysqli_connect.php');				}								// Check when the user gets paid				$queryPay = "SELECT payday FROM users WHERE user_id = " . $_SESSION['user_id'] . "";								$rp = mysqli_query($dbc, $queryPay);				$rowPay = mysqli_fetch_array($rp, MYSQLI_ASSOC);								/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				// Check the dates function. Takes the day and runs it through checkdate				// If checkdate fails initiate a backwards loop until we get a valid day				function validateDay($day) {					$month = date("m", strtotime("last month") );					$year = date("Y", strtotime("last month") );					if ( checkdate($month, $day, $year) ) {						// Date passes check, return as string						return $day;											} elseif ( !checkdate($month, $day, $year) ) {						// Date is invlaid, reduce by one until it passes validation						while ( !checkdate($month, $day, $year) ) {							$day--;						} //END WHILE						return $day;					} // END ELSEIF				} //END VALIDATEDAY								/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				//Check if the last date of pay was in this month or last month				//Do this by determining if current day is less than date of pay, equal to (got paid today) or greater then (got paid this month)				function lastPay($day) {					$currentDay = date('d');					$date = date('Y-m-' . $day);					$date = strtotime($date);					$date = date('D', $date);					if ($date ==='Sat') {						$day -= 1;					} if ($date ==='Sun') {						$day -= 2;					}					if ( $currentDay < $day ) {						// Got paid last month						$fromDateMonth = date('Y-m-' . $day, strtotime("last month") );						return $fromDateMonth;											} elseif ( $currentDay == $day ) {						// Got paid today						$fromDateMonth = date('Y-m-d');						return $fromDateMonth;											} elseif ( $currentDay > $day ) {						// Got paid this month						$fromDateMonth = date('Y-m-' . $day);						return $fromDateMonth;											}				} //END LASTPAY							echo '<div class="section">';	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////				if ($rp) {					// Check payday result and format the query to see how much spent since last pay					if ( $rowPay['payday'] == 'last' ) { // User gets paid on the last day of every month						$day = date('d',  strtotime('last day of last month') );												//Check when they last got paid						$fromDateMonth = lastPay($day);											} if ( is_numeric($rowPay['payday']) ) { // User gets paid on the XX of the month						// Check this payday is valid, ie. in range of previous month						$day = $rowPay['payday'];						$day = validateDay($day);						$fromDateMonth = lastPay($day);											}					//echo '<h2>' . $fromDateMonth . '</h2>';				} else {					echo '<h2>AN ERROR OCCURRED</h2>';					echo '<p class="error">Query could not be executed.</p>';				}								if ( isset($_POST['spend-category']) ) {					$cat = $_POST['spend-category'];					$query = "SELECT time, SUM(amount) AS 'sum' FROM monthly_spends_" . $user . " WHERE category = '$cat' AND time > '$fromDateMonth';";					$query2 = "SELECT time, SUM(amount) AS 'sum' FROM monthly_spends_" . $user . " WHERE category = '$cat';";									} else {					'<h2>An error has occurred</h2>';					'<p class="error">No category selected.</p>';				}                //$query = "SELECT time, SUM(amount) AS 'sum' FROM monthly_spends_" . $user . " WHERE time > '$fromDateMonth';";				                $r = mysqli_query($dbc, $query);                $row = mysqli_fetch_array($r, MYSQLI_ASSOC);								                $r2 = mysqli_query($dbc, $query2);                $row2 = mysqli_fetch_array($r2, MYSQLI_ASSOC);								                if ($r) {					echo '<h2>Spending on ' . $cat . '</h2>';					echo '<div class="divider">';					echo '<small>Since last payday: </small><h2>£';					if ( $row['sum'] <= 0 ) {						echo '0.00</h2>'; 					} else {                    	echo $row['sum'] . '</h2>';					}					echo '</div>';					echo '<div class="divider">';					echo '<small>Total:</small><h2>£';					if ( $row2['sum'] <= 0 ) {						echo '0.00</h2>'; 					} else {                    	echo $row2['sum'] . '</h2>';					}					                } else {                    echo '<h2>No category selected</h2>';                }				echo '</div>'; // divider    						echo '</div>'; // section            ?>        <div id="actions">            <a href="index.php" id="update-link">Update spending</a>            <!--<a href="query.php" id="view-link">View spending</a>-->        </div><?php				include ('includes/footer.html');?>